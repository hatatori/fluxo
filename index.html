<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="style2.css">


<textarea id="txt" style="width: 100%;height: 200;margin-bottom: 10px">a
	b
		c
		d
			e
				f
				g
				h
			g
				p
				q
				r
				s
				t
		i
			j
		k
			l
		m
			n
				n</textarea>

<div class="tf-tree example" id="ok"></div>
<!-- <div class="" id="ok"></div> -->

<script>
	
	function jogaPraCima(n){
		try{
			u.children[n-1].querySelector('ul').appendChild(u.children[n])
		}catch(e){}
	}

	function jogaProUltimo(n){
		try{
			ultimo = u.children[n-1]

			ultimo.querySelectorAll('ul')

			len = ultimo.querySelectorAll('ul').length-1

			kz = ultimo.querySelectorAll('ul')[len]

			kz.appendChild(u.children[n])
		}
		catch(e){}
	}


	function getName(n){
	    return u.children[n].getAttribute('name')
	}

	function getP(n){
	    return parseInt(u.children[n].getAttribute('p'))
	}

	// function return_ul(n){
	// 	return u.querySelectorAll("ul")[n]
	// }

	function return_ul_in(n){
		return parseInt(u.querySelectorAll("ul")[n].getAttribute('u'))
	}
	

	//retorna quantidade de tab na linha n
	function tab(n){
		try{
			return parseInt(linha[n].match(/\t/g).length)
		}catch(e){
			return 0
		}
	}
	

	//cria todo o esquema
	function cria(a){
		t = ""

		// linha = txt.value.split("\n");
		linha = a.split("\n")

		u = document.createElement("ul")

		for(i=0;i<linha.length;i++){

			maior = tab(i+1) > tab(i)
			col = tab(i)


			linha[i] = linha[i].replace(/\t/g,"")


			if(maior)
				t += "<li name='a' p="+col+"><span class='tf-nc'>"+linha[i]+"</span><ul u="+col+"></ul></li>"
			else
				t += "<li name='c' p="+col+"><span class='tf-nc'>"+linha[i]+"</span></li>"
		}

		u.innerHTML = t
	}
	

	// ajusta o esquema

	function organiza1(){
		for( i = linha.length-1 ;  i >= 0 ;i--){
			try{

				igual = getP(i) == getP(i-1)
				menor = getP(i) < getP(i-1)
				maior = getP(i) > getP(i-1)

				nome_igual = getP(i)==getP(i-1)
				nome_diferente = getP(i)!=getP(i-1)


				if(maior && nome_diferente && return_ul_in(i-1) < getP(i))
					jogaPraCima(i)


			}catch(e){}

		}
	}

	function organiza2(){
		for( i = linha.length-1 ;  i >= 0 ;i--){
			try{

				igual = getP(i) == getP(i-1)
				menor = getP(i) < getP(i-1)
				maior = getP(i) > getP(i-1)

				nome_igual = getP(i)==getP(i-1)
				nome_diferente = getP(i)!=getP(i-1)


				if(maior && nome_diferente && return_ul_in(i-1) < getP(i)){
					jogaProUltimo(i)
				}


			}catch(e){}

		}
	}

	function organiza3(){
		
		li = u.querySelectorAll("li")

		try{

		for( i = li.length-1 ;  i >= 0 ;i--){	

			numero_pai = parseInt(u.querySelectorAll("li")[i].parentElement.getAttribute("u"))
			numero_avo = parseInt(u.querySelectorAll("li")[i].parentElement.getAttribute("p"))
			numero = parseInt(u.querySelectorAll("li")[i].getAttribute("p"))

			if(numero <= numero_pai || numero <= numero_avo)
				u.querySelectorAll("li")[i].parentElement.parentElement.appendChild(u.querySelectorAll("li")[i])
		}
	}catch(e){}

}


	//modela 
	
	function render(n){

		cria(n)
		
		organiza1()

		organiza2()
		organiza2()
		organiza2()
		organiza2()
		organiza2()
		organiza2()
		organiza2()

		organiza3()
		organiza3()
		organiza3()
		organiza3()
		organiza3()
		organiza3()
		organiza3()
		organiza3()


		ok.innerHTML = u.outerHTML

		return u.outerHTML
	}


	render(txt.value)

	txt.onkeydown=function(e){

		console.log(e.key)

		if(e.key == "Tab"){

			start = this.selectionStart;
    		end = this.selectionEnd;

    		this.value = this.value.substring(0, start)+"\t"+this.value.substring(end)

    		this.selectionStart = this.selectionEnd = start + 1;
			e.preventDefault()
		}


	}

	txt.onkeyup=function(e){
		// if(e.key == 9){
		// 	alert('ok')
		// }
		// e.preventDefault()
		// if (e.keyCode == 9) {alert('ok')}

		// console.log(this.value)
		render(this.value)
	}


</script>